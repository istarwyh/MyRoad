连接数据库是一个很容易出错,出错后因为原因众多又难以定位的一个bug.

## 1. 检查数据库连接配置 

### 1.1. 密码什么的错误吗?
### 1.2. 确认用户权限
1. 创建用户时需要这样:
```sql
GRANT ALL PRIVILEGES ON *.* TO 'itoffice'@'%' IDENTIFIED BY 'itoffice' WITH GRANT OPTION;
flush privileges;
```
第一个itoffice表示用户名，%表示所有的电脑都可以连接，也可以设置某个ip地址运行连接(这样安全些)，第二个itoffice表示密码[^用户权限]:
[^用户权限]
![](https://gitee.com/istarwyh/images/raw/master/1592828559_20200622065304296_3467.png)  
2. 检查是否创建成功
`SELECT DISTINCT CONCAT('User: ''',user,'''@''',host,''';') AS query FROM mysql.user;`
或者这样检查
![](https://gitee.com/istarwyh/images/raw/master/1592828560_20200622123559120_11222.png)
### 1.3. 使用`com.mysql.jdbc.Driver`时
或者简单点说就是你的url咋写的
- `jdbc:mysql://127.0.0.1:3306/ --username hive --password hive`
- `jdbc:mysql://127.0.0.1:3306/hive?characterEncoding=utf-8 --username hive --password hive`
**注意第二种**
### 1.4. 使用`com.mysql.cj.jdbc.Driver`
貌似还需要指定时区那些,暂略
## 2. 测试本地连接
写一个简单的jdbc数据库测试本地连接[^测试本地连接]
[^测试本地连接]:[JDBC数据库连接本地数据库的报错问题：Communications link failure](https://blog.csdn.net/qq_41907816/article/details/89104699?utm_medium=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase&depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-BlogCommendFromMachineLearnPai2-1.nonecase)

![](https://gitee.com/istarwyh/images/raw/master/1592828557_20200622063755308_23608.png)

## 3. 各版本对应关系
### 3.1. mysql-connector-java与Mysql对应版本
`mysql>select version()`可以查看数据库版本.
![](https://gitee.com/istarwyh/images/raw/master/1592828557_20200622063549719_10920.png)
### 3.2. mysql-connector-java与Java对应版本
![](https://gitee.com/istarwyh/images/raw/master/1592828557_20200622063659410_2684.png)
### 3.3. openSSL
- **5.x版本**
```properties
driver=com.mysql.jdbc.Driver
url=jdbc:mysql://localhost:3306/mybatis?useSSL=false&useUnicode=true&characterEncoding=UTF-8
```
注意useSSL=false必须为`false`

- **8.x版本**
```properties
driver=com.mysql.cj.jdbc.Driver
url=jdbc:mysql://localhost:3306/mybatis?useSSL=true&useUnicode=true&characterEncoding=UTF-8&serverTimezone=U
```
## 4. 排查是否线程超时
### 4.1. Mysql服务器默认的“wait_timeout”是8小时
`mysql﹥ show global variables like 'wait_timeout'; `可以查看到,这意味着如果一个`connection`空闲超过8个小时，Mysql将自动断开该connection。

### 4.2. 重置`wait_timeout`
```sh
set global wait_timeout=604800; 

set global interactive_timeout=604800;
```

或者直接修改`my.ini`(windows下),`my.cnf`(linux下)
## 5. 防火墙是否关闭
**默认是关闭的.**但是依然有可能屏蔽3306端口.

1. 设置防火墙允许3306端口
`vi /etc/sysconfig/IPtables`
2. 添加（添加在`-A RH-Firewall-1-INPUT -j REJECT –reject-with icmp-host-prohibited`之前）
`-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 3306 -j ACCEPT`


3. 重启防火墙
`service iptables restart`

## 6. Mysql默认跟随Ubuntu等使用的验证插件有问题
以至于在`root@%`的情况下能使用`localhost`登录,不能使用`127.0.0.1`登录,并在修改user表至下图后:
![](https://gitee.com/istarwyh/images/raw/master/1613976081_20210124180250907_31089.png)
造成下面[Error 1698](https://stackoverflow.com/questions/39281594/error-1698-28000-access-denied-for-user-rootlocalhost) 和 [Error 1045](https://stackoverflow.com/questions/21944936/error-1045-28000-access-denied-for-user-rootlocalhost-using-password-y/42967789#42967789)同框:
![](https://gitee.com/istarwyh/images/raw/master/1613976081_20210124180040702_31026.png)
最终只能卸载Mysql,重新解决1698的问题.并注意重新设置验证插件后,**没有密码**,需重新指定密码.

## 7. 其他
error2003,可以限制只监听3306端口,但是放开所有IP

update-alternatives: 使用 /etc/mysql/my.cnf.fallback 来在自动模式中提供 /etc/mysql/my.cnf (my.cnf)
## 8. 各人谈数据库
### 8.1. 多是数据密集型应用
>Xujiu@Sapesn:大部分APP-数据密集型应用，不从轮子做起,就与数据结构和算法没关系。主要创造性的工作往往在**数据模型**和**数据流设计**上。实际生产中，数据表就是数据结构，索引和查询就是算法，应用代码往往扮演胶水角色，处理IO和业务逻辑，在数据库系统之间搬运数据。架构师最重要的能力之一，就是能够灵活地权衡取舍/集成拼接数据系统。
第一代:网状和层次数据库系统
第二代:关系型数据库系统
第三代:面向对象数据模型为主要特征的数据库系统
>- 支持一致性管理/对象管理/事务管理

>其他：非关系型数据库，NoSQL(Not only SQL)
>- 主要强调数据库的高并发读写和存储大数据
### 8.2. Not Only Sql
- 关系数据库难以应付复杂数据
    - json树类结构
    - 社交关系等图结构
- 大数据可能并不需要ACID,比如转发的微博,可以异步/错误/不清晰
- 传统数据库底层是B树/B+树,降低树的高度避免IO,但存储性能值得探讨
### 8.3. ACID vs CAP
|              词语               |                 数据库                  |              CAP              | 迷惑? |
| ------------------------------- | --------------------------------------- | ----------------------------- | ----- |
| 事务                            | 一组不可分割的操作(包括ACID)             | -                             | -      |
| 持久化 (Durability)             | 状态更改故障/重启后不受影响               | -                             | -      |
| 一致性(Consistency)             | 数据本身的完整性约束(数据类型,范围.etc)   | "原子一致性"模型的简称         | 不同义 |
| 隔离性(Isolation)               | 多个事务并发执行结果可以像事务顺序执行一般 | 被包含着CAP的一致性模型中      | 被包含 |
| 原子性(Atomicity)               | 所有更改要么全部发生,要么全部不发生       | 原子一致性模型                 | 不同义 |
| 可用性(Availability)            | 按时间计使用率                           | 非故障节点应至少响应一次        | 不同义 |
| 分区容错性(Partition-toleranceh) | - \ (水平分片&垂直分区?)                 | 两组节点分区时,它们之间消息丢失 | -      |

note:

- 顺序一致性:所有处理器的内存访问是交叉的,然而程序的行为好像它们是按顺序执行的
- 原子/线性一致性:顺序一致性+**实时约束**.线性一致性假设所有处理器共享全局时间
- Isolation
    - `serializable`可序列化:读写均锁**表**,强行**单线程**操作....开发人员可以躺平了
    - `repeatable read`:事务开始时建立一致性视图,读取时若`DB_TRX_ID`(处理的事务数ID)在视图建立前未提交,则读到的是原来的数据(多版本并发`MVCC`的基础)
    - `read committed`读取已提交数据:写的时候锁行,写完了commit再允许被读
    - `read uncommitted`读取未提交数据:什么也不做,只要内存中改了记录就能被读
- Base理论，基本可用->最终一致性